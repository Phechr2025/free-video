{% extends "base.html" %}
{% block title %}บัญชีของฉัน{% endblock %}

{% block content %}
<h1>บัญชีของฉัน</h1>

<p style="margin-bottom:0.75rem;">ชื่อผู้ใช้ปัจจุบัน: <strong>{{ user['username'] }}</strong></p>

<section style="margin-bottom:1.5rem;">
  <h2 style="margin-bottom:0.5rem;">เปลี่ยนรหัสผ่าน</h2>
  <form method="post" class="form">
    <input type="hidden" name="action" value="change_password" />
    <label for="current_password">รหัสผ่านเดิม</label>
    <input type="password" id="current_password" name="current_password" required />

    <label for="new_password">รหัสผ่านใหม่</label>
    <input type="password" id="new_password" name="new_password" required />

    <label for="confirm_password">ยืนยันรหัสผ่านใหม่</label>
    <input type="password" id="confirm_password" name="confirm_password" required />

    <button type="submit" class="btn primary">บันทึกการเปลี่ยนรหัสผ่าน</button>
  </form>
</section>

<section style="margin-bottom:1.5rem;">
  <h2 style="margin-bottom:0.5rem;">Key ของบัญชี</h2>
  <p class="hint">
    ใช้ key นี้เพื่อให้แอดมินค้นหาบัญชีของคุณได้ง่ายขึ้น
  </p>

  <div style="display:flex;flex-wrap:wrap;gap:0.5rem;align-items:center;margin-bottom:0.75rem;">
    <input
      type="text"
      id="account-key"
      value="{{ user['user_key'] or '' }}"
      readonly
      style="flex:1;min-width:160px;"
    />
    <button type="button" class="btn" onclick="copyAccountKey()">คัดลอก key</button>
  </div>

  <form method="post" onsubmit="return confirm('ยืนยันการรีเซ็ต key ใหม่?');">
    <input type="hidden" name="action" value="reset_key" />
    <button type="submit" class="btn danger">รีเซ็ต key ใหม่</button>
  </form>
</section>

<section>
  <h2 style="margin-bottom:0.5rem;">อุปกรณ์ที่ล็อกอินอยู่</h2>
  <p class="hint">ระบบจะอัปเดตอัตโนมัติทุก ๆ 1 วินาที</p>

  <div style="display:flex;flex-wrap:wrap;gap:0.5rem;align-items:center;margin:0.75rem 0;">
    <button type="button" class="btn danger" onclick="logoutAllOthers()">บังคับให้ออกจากบัญชี (ทุกอุปกรณ์อื่น)</button>
    <button type="button" class="btn" onclick="refreshSessions()">รีเฟรช</button>
  </div>

  <div id="sessions-status" class="hint" style="margin-bottom:0.5rem;"></div>

  <div style="overflow:auto;">
    <table class="table" id="sessions-table" style="min-width:700px;display:none;">
      <thead>
        <tr>
          <th>อุปกรณ์/ระบบ</th>
          <th>IP</th>
          <th>ใช้งานล่าสุด</th>
          <th>เริ่มล็อกอิน</th>
          <th>รายละเอียด</th>
          <th>จัดการ</th>
        </tr>
      </thead>
      <tbody id="sessions-body"></tbody>
    </table>
  </div>

  <div id="sessions-empty" style="display:none;">
    <p>ยังไม่มีอุปกรณ์ที่ล็อกอินอยู่</p>
  </div>
</section>

<script>
  function copyAccountKey() {
    var input = document.getElementById("account-key");
    if (!input) return;
    input.select();
    input.setSelectionRange(0, 99999);
    try {
      var ok = document.execCommand("copy");
      if (ok) {
        alert("คัดลอก key แล้ว");
      } else {
        alert("ไม่สามารถคัดลอก key ได้ กรุณาคัดลอกเอง");
      }
    } catch (e) {
      alert("ไม่สามารถคัดลอก key ได้ กรุณาคัดลอกเอง");
    }
  }

  function escapeHtml(s) {
    return (s || "").replace(/[&<>"']/g, function(m) {
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]);
    });
  }

  async function postForm(url, dataObj) {
    var body = new URLSearchParams();
    Object.keys(dataObj).forEach(function(k){ body.append(k, dataObj[k]); });
    var res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: body.toString()
    });
    return res;
  }

  function fmtTime(iso) {
    if (!iso) return "-";
    try {
      // แสดงตามเวลาเครื่องผู้ใช้
      var d = new Date(iso);
      return d.toLocaleString();
    } catch (e) {
      return iso;
    }
  }

  async function refreshSessions() {
    var statusEl = document.getElementById("sessions-status");
    var table = document.getElementById("sessions-table");
    var empty = document.getElementById("sessions-empty");
    var body = document.getElementById("sessions-body");

    try {
      var res = await fetch("/account/sessions", { cache: "no-store" });

      // อ่านเป็น text ก่อน เพื่อกันกรณีได้ HTML (เช่นถูก redirect ไปหน้า login)
      var text = await res.text();

      // ถ้า HTTP ไม่ใช่ 200 หรือไม่ใช่ JSON ให้ถือว่าออกจากระบบแล้ว
      var trimmed = (text || "").trim();
      if (!res.ok || !trimmed.startsWith("{")) {
        statusEl.textContent = "ออกจากระบบแล้ว หรือถูกบังคับออก (โปรดเข้าสู่ระบบใหม่)";
        table.style.display = "none";
        empty.style.display = "block";
        return;
      }

      var data = JSON.parse(trimmed);
      if (!data.ok) throw new Error(data.error || "unknown");

      var sessions = data.sessions || [];
      statusEl.textContent = "กำลังล็อกอินอยู่: " + sessions.length + " อุปกรณ์";

      body.innerHTML = "";
      if (sessions.length === 0) {
        table.style.display = "none";
        empty.style.display = "block";
        return;
      }

      sessions.forEach(function(s) {
        var tr = document.createElement("tr");

        var device = document.createElement("td");
        device.innerHTML = escapeHtml(s.platform || "Other") + (s.is_current ? " <strong>(เครื่องนี้)</strong>" : "");
        tr.appendChild(device);

        var ip = document.createElement("td");
        ip.textContent = s.ip || "-";
        tr.appendChild(ip);

        var last = document.createElement("td");
        last.textContent = fmtTime(s.last_seen);
        tr.appendChild(last);

        var created = document.createElement("td");
        created.textContent = fmtTime(s.created_at);
        tr.appendChild(created);

        var ua = document.createElement("td");
        ua.style.maxWidth = "260px";
        ua.style.wordBreak = "break-word";
        ua.textContent = s.user_agent || "";
        tr.appendChild(ua);

        var actions = document.createElement("td");

        var btnKick = document.createElement("button");
        btnKick.type = "button";
        btnKick.className = "btn small";
        btnKick.textContent = "บังคับออก";
        btnKick.disabled = s.is_current ? true : false;
        btnKick.onclick = async function() {
          if (!confirm("ยืนยันบังคับให้อุปกรณ์นี้ออกจากบัญชี?")) return;
          await postForm("/account/sessions/logout", { mode: "one", session_id: String(s.id) });
          await refreshSessions();
        };
        actions.appendChild(btnKick);

        if (s.is_current) {
          var btnMe = document.createElement("button");
          btnMe.type = "button";
          btnMe.className = "btn small danger";
          btnMe.style.marginLeft = "0.25rem";
          btnMe.textContent = "ออกจากระบบ";
          btnMe.onclick = function() {
            window.location.href = "/logout";
          };
          actions.appendChild(btnMe);
        }

        tr.appendChild(actions);
        body.appendChild(tr);
      });

      table.style.display = "";
      empty.style.display = "none";
    } catch (e) {
      statusEl.textContent = "โหลดข้อมูลอุปกรณ์ไม่สำเร็จ";
    }
  }

  async function logoutAllOthers() {
    if (!confirm("ยืนยันบังคับให้ออกจากบัญชีทุกอุปกรณ์อื่น?")) return;
    await postForm("/account/sessions/logout", { mode: "all_others" });
    await refreshSessions();
  }

  // อัปเดตทุก 1 วินาที
  refreshSessions();
  setInterval(refreshSessions, 1000);
</script>
{% endblock %}
